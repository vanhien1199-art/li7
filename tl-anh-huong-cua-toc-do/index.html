<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i 11: T·ªëc ƒë·ªô v√† An to√†n giao th√¥ng</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        window.lessonId = 'toc-do-an-toan-giao-thong';
        document.addEventListener('DOMContentLoaded', () => {
            const chatWindow = document.getElementById('chat-window');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const AI_SERVICE_URL = 'https://ai-trung-tam-service.onrender.com';
            const LESSON_ID = window.lessonId || 'default';
            if(sendButton){
                sendButton.addEventListener('click', askAI);
                userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') askAI(); });
            }
            function addMessageToChat(text, className) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('chat-message', className);
                chatWindow.appendChild(messageElement);
                messageElement.innerHTML = marked.parse(text);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                return messageElement;
            }
            async function askAI() {
                const question = userInput.value.trim();
                if (!question) return;
                addMessageToChat(question, 'user-message');
                userInput.value = '';
                const waitingMessage = addMessageToChat('Tr·ª£ l√Ω AI ƒëang suy nghƒ©...', 'ai-message');
                try {
                    const response = await fetch(`${AI_SERVICE_URL}/ask`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question: question, lesson_id: LESSON_ID })
                    });
                    if (!response.ok) throw new Error('L·ªói m·∫°ng ho·∫∑c server');
                    const data = await response.json();
                    waitingMessage.innerHTML = marked.parse(data.answer);
                } catch (error) {
                    waitingMessage.innerHTML = marked.parse('**Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra!**');
                }
            }
        });
    </script>

    <style>
        :root {
            --primary-color: #c62828; /* ƒê·ªè c·∫£nh b√°o */
            --secondary-color: #ffb300; /* V√†ng */
            --bg-color: #fce4ec;
            --card-bg-color: #ffffff;
            --text-color: #333;
            --correct-color: #4caf50;
            --incorrect-color: #f44336;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.7; background-color: var(--bg-color); color: var(--text-color); margin: 0; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        header { background-color: var(--primary-color); color: white; padding: 1.5rem 1rem; text-align: center; margin-bottom: 30px; position: relative; }
        header h1 { margin: 0; font-size: 2.5em; }
        .card { background-color: var(--card-bg-color); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); padding: 30px; margin-bottom: 30px; }
        h2, h3, h4 { color: var(--primary-color); }
        h2 { border-bottom: 3px solid var(--secondary-color); padding-bottom: 10px; margin-top: 0; }
        button { background-color: var(--secondary-color); color: var(--text-color); border: none; padding: 10px 20px; font-size: 1em; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; }
        button:hover { background-color: #ffa000; }
        
        .home-btn { position: absolute; top: 50%; left: 20px; transform: translateY(-50%); font-size: 28px; color: white; text-decoration: none; opacity: 0.8; }
        
        /* Ph·∫ßn I: M√¥ ph·ªèng Kho·∫£ng c√°ch an to√†n */
        .road-container { position: relative; height: 150px; background-color: #757575; border-radius: 5px; margin: 20px 0; overflow: hidden; border-top: 5px solid #424242; border-bottom: 5px solid #424242; }
        .road-lines { position: absolute; top: 50%; left: 0; width: 100%; height: 5px; border-top: 5px dashed white; transform: translateY(-50%); }
        .car-svg { position: absolute; width: 100px; height: 50px; top: 50%; transform: translateY(-50%); transition: left 0.5s ease-out; }
        #front-car { left: 70%; }
        #user-car { left: 20%; }
        #brake-feedback { font-size: 1.5em; font-weight: bold; text-align: center; margin-top: 15px; }
        .info-box { background-color: #f1f1f1; padding: 15px; border-radius: 5px; margin-top: 15px; }
        
        @keyframes crash { 0% { transform: translateY(-50%) translateX(0); } 25% { transform: translateY(-50%) translateX(-5px) rotate(-1deg); } 50% { transform: translateY(-50%) translateX(5px) rotate(1deg); } 75% { transform: translateY(-50%) translateX(-5px) rotate(-1deg); } 100% { transform: translateY(-50%) translateX(0); } }
        #user-car.crashed { animation: crash 0.5s; }
        
        /* Ph·∫ßn IV: Luy·ªán t·∫≠p */
        .feedback { margin-top: 10px; font-weight: bold; }
        .feedback.correct { color: var(--correct-color); }
        .feedback.incorrect { color: var(--incorrect-color); }

        /* CSS Chatbot, Footer, Back-to-Top */
        .chat-window { height: 300px; border: 1px solid #ccc; padding: 10px; overflow-y: auto; margin-bottom: 10px; }
        .chat-message { margin-bottom: 10px; } .user-message { text-align: right; }
        .ai-message { background-color: #f1f1f1; padding: 10px; border-radius: 8px; display: inline-block; max-width: 90%; text-align: left; }
        .chat-input-area { display: flex; gap: 10px; } .chat-input-area input { flex-grow: 1; }
        .site-footer { background-color: #333; color: #f1f1f1; padding: 30px 0; font-size: 0.9em; }
        .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .site-footer h4 { color: var(--secondary-color); } .site-footer ul { list-style-type: none; padding: 0; }
        .site-footer a { color: #f1f1f1; text-decoration: none; } .site-footer a:hover { color: var(--secondary-color); }
        #back-to-top-btn { display: none; position: fixed; bottom: 20px; right: 20px; z-index: 999; background-color: var(--secondary-color); color: var(--text-color); cursor: pointer; padding: 10px; border-radius: 50%; font-size: 18px; width: 50px; height: 50px; text-align: center; line-height: 30px; text-decoration: none; border: none;}
    </style>
</head>
<body id="page-top">
    <header>
        <a href="/" class="home-btn" title="V·ªÅ trang ch·ªß">üè†</a>
        <h1>B√†i 11: T·ªêC ƒê·ªò V√Ä AN TO√ÄN GIAO TH√îNG</h1>
    </header>

    <div class="container">
        <section id="phan1" class="card">
            <h2>Ph·∫ßn I: M√¥ ph·ªèng "Kho·∫£ng c√°ch an to√†n"</h2>
            <p>H√£y ƒëi·ªÅu ch·ªânh t·ªëc ƒë·ªô c·ªßa xe b·∫°n (m√†u xanh) v√† xem kho·∫£ng c√°ch an to√†n c·∫ßn thi·∫øt thay ƒë·ªïi nh∆∞ th·∫ø n√†o. Sau ƒë√≥, h√£y th·ª≠ phanh g·∫•p ƒë·ªÉ ki·ªÉm tra!</p>
            <div class="road-container">
                <div class="road-lines"></div>
                <svg id="front-car" class="car-svg" viewBox="0 0 100 50">
                    <path d="M 10 35 L 20 20 L 80 20 L 90 35 Z" fill="#607d8b"/>
                    <rect x="0" y="35" width="100" height="10" rx="5" fill="#37474f"/>
                    <circle cx="25" cy="45" r="7" fill="#212121"/><circle cx="75" cy="45" r="7" fill="#212121"/>
                </svg>
                <svg id="user-car" class="car-svg" viewBox="0 0 100 50">
                    <path d="M 10 35 L 20 20 L 80 20 L 90 35 Z" fill="var(--primary-color)"/>
                    <rect x="0" y="35" width="100" height="10" rx="5" fill="#0d47a1"/>
                    <circle cx="25" cy="45" r="7" fill="#212121"/><circle cx="75" cy="45" r="7" fill="#212121"/>
                </svg>
            </div>
            <div class="controls">
                <label for="speed-slider">T·ªëc ƒë·ªô c·ªßa b·∫°n: <span id="speed-value">60</span> km/h</label>
                <input type="range" id="speed-slider" min="0" max="120" value="60" style="width: 100%;">
                <div class="info-box">
                    <p>Kho·∫£ng c√°ch an to√†n t·ªëi thi·ªÉu theo quy ƒë·ªãnh: <strong id="legal-distance">35 m</strong></p>
                    <p>Kho·∫£ng c√°ch ∆∞·ªõc t√≠nh theo "Quy t·∫Øc 3 gi√¢y": <strong id="three-sec-distance">50 m</strong></p>
                </div>
                <button id="brake-btn">Th·ª≠ phanh g·∫•p!</button>
                <div id="brake-feedback"></div>
            </div>
        </section>

        <section id="phan2" class="card">
            <h2>Ph·∫ßn II: Bi·ªÉu ƒë·ªì T∆∞∆°ng t√°c "Th·ªëng k√™ Tai n·∫°n Giao th√¥ng t·∫°i Vi·ªát Nam"</h2>
            <p>D∆∞·ªõi ƒë√¢y l√† bi·ªÉu ƒë·ªì th·ªÉ hi·ªán s·ªë v·ª• v√† s·ªë ng∆∞·ªùi ch·∫øt v√¨ tai n·∫°n giao th√¥ng (TNGT) ƒë∆∞·ªùng b·ªô t·∫°i Vi·ªát Nam giai ƒëo·∫°n 2016-2020. H√£y di chu·ªôt qua c√°c c·ªôt ƒë·ªÉ xem s·ªë li·ªáu chi ti·∫øt.</p>
            <div>
                <canvas id="traffic-chart"></canvas>
            </div>
        </section>

        <section id="phan3" class="card">
            <h2>Ph·∫ßn III: Ki·∫øn th·ª©c c·ªët l√µi c·∫ßn nh·ªõ</h2>
            <ul>
                <li>Lu√¥n tu√¢n th·ªß quy ƒë·ªãnh v·ªÅ <strong>gi·ªõi h·∫°n t·ªëc ƒë·ªô</strong> cho t·ª´ng lo·∫°i xe v√† cung ƒë∆∞·ªùng ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n.</li>
                <li>Lu√¥n gi·ªØ <strong>kho·∫£ng c√°ch an to√†n</strong> v·ªõi xe ch·∫°y li·ªÅn tr∆∞·ªõc. Kho·∫£ng c√°ch n√†y c√†ng l·ªõn khi t·ªëc ƒë·ªô c√†ng cao v√† khi th·ªùi ti·∫øt x·∫•u.</li>
                <li><strong>"Quy t·∫Øc 3 gi√¢y"</strong> l√† m·ªôt ph∆∞∆°ng ph√°p th·ª±c t·∫ø h·ªØu √≠ch ƒë·ªÉ ∆∞·ªõc t√≠nh kho·∫£ng c√°ch an to√†n trong ƒëi·ªÅu ki·ªán th·ªùi ti·∫øt t·ªët. C√°ch th·ª±c hi·ªán: Ch·ªçn m·ªôt m·ªëc c·ªë ƒë·ªãnh b√™n ƒë∆∞·ªùng. Khi xe tr∆∞·ªõc v·ª´a ƒëi qua m·ªëc, b·∫Øt ƒë·∫ßu ƒë·∫øm "m·ªôt gi√¢y, hai gi√¢y, ba gi√¢y". N·∫øu xe b·∫°n t·ªõi m·ªëc tr∆∞·ªõc khi ƒë·∫øm xong, b·∫°n ƒëang ·ªü qu√° g·∫ßn.</li>
            </ul>
        </section>

        <section id="ai-chatbot-card" class="card">
            <h3>ü§ñ Tr·ª£ l√Ω AI</h3>
            <p>B·∫°n c√≥ c√¢u h·ªèi n√†o v·ªÅ c√°c quy t·∫Øc an to√†n giao th√¥ng hay c√°ch t√≠nh kho·∫£ng c√°ch kh√¥ng?</p>
            <div id="chat-window" class="chat-window"></div>
            <div class="chat-input-area">
                <input type="text" id="user-input" placeholder="V√≠ d·ª•: Quy t·∫Øc 3 gi√¢y l√† g√¨?">
                <button id="send-button">G·ª≠i</button>
            </div>
        </section>

        <section id="phan4" class="card">
            <h2>Ph·∫ßn IV: Tr·∫Øc nghi·ªám t√¨nh hu·ªëng</h2>
            <div class="exercise-item">
                <h4>C√¢u 1: B·∫°n ƒëang l√°i xe v·ªõi t·ªëc ƒë·ªô trong kho·∫£ng 80 km/h ƒë·∫øn 100 km/h. Kho·∫£ng c√°ch an to√†n t·ªëi thi·ªÉu b·∫°n c·∫ßn gi·ªØ v·ªõi xe tr∆∞·ªõc l√† bao nhi√™u?</h4>
                <div><label><input type="radio" name="q1" value="a"> 35 m</label></div>
                <div><label><input type="radio" name="q1" value="b"> 55 m</label></div>
                <div><label><input type="radio" name="q1" value="c" data-correct="true"> 70 m</label></div>
                <div id="feedback-q1" class="feedback"></div>
            </div>
            <div class="exercise-item">
                <h4>C√¢u 2: Khi xe ph√≠a tr∆∞·ªõc v·ª´a ƒëi qua m·ªôt c·ªôt m·ªëc, b·∫°n b·∫Øt ƒë·∫ßu ƒë·∫øm "m·ªôt gi√¢y, hai gi√¢y, ba gi√¢y" v√† xe c·ªßa b·∫°n c≈©ng v·ª´a t·ªõi c·ªôt m·ªëc ƒë√≥. ƒêi·ªÅu n√†y c√≥ nghƒ©a l√† g√¨?</h4>
                 <div><label><input type="radio" name="q2" value="a"> B·∫°n ƒëang ·ªü qu√° xa xe tr∆∞·ªõc.</label></div>
                <div><label><input type="radio" name="q2" value="b" data-correct="true"> B·∫°n ƒëang gi·ªØ m·ªôt kho·∫£ng c√°ch an to√†n (trong ƒëi·ªÅu ki·ªán t·ªët).</label></div>
                <div><label><input type="radio" name="q2" value="c"> B·∫°n ƒëang ·ªü qu√° g·∫ßn v√† c·∫ßn ƒëi ch·∫≠m l·∫°i.</label></div>
                <div id="feedback-q2" class="feedback"></div>
            </div>
             <div class="exercise-item">
                <h4>C√¢u 3: T·∫°i sao xe t·∫£i n·∫∑ng th∆∞·ªùng c√≥ gi·ªõi h·∫°n t·ªëc ƒë·ªô th·∫•p h∆°n xe con tr√™n c√πng m·ªôt con ƒë∆∞·ªùng?</h4>
                 <div><label><input type="radio" name="q3" value="a"> V√¨ xe t·∫£i g√¢y √¥ nhi·ªÖm nhi·ªÅu h∆°n.</label></div>
                <div><label><input type="radio" name="q3" value="b"> V√¨ ƒë·ªông c∆° xe t·∫£i y·∫øu h∆°n.</label></div>
                <div><label><input type="radio" name="q3" value="c" data-correct="true"> V√¨ xe t·∫£i c√≥ qu√°n t√≠nh l·ªõn, c·∫ßn qu√£ng ƒë∆∞·ªùng d√†i h∆°n ƒë·ªÉ phanh d·ª´ng l·∫°i an to√†n.</label></div>
                <div id="feedback-q3" class="feedback"></div>
            </div>
        </section>
    </div>

    <footer class="site-footer">
        </footer>
    <a href="#page-top" id="back-to-top-btn" title="L√™n ƒë·∫ßu trang">‚¨ÜÔ∏è</a>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- PH·∫¶N I: M√î PH·ªéNG KHO·∫¢NG C√ÅCH AN TO√ÄN ---
        const speedSlider = document.getElementById('speed-slider');
        const speedValue = document.getElementById('speed-value');
        const legalDist = document.getElementById('legal-distance');
        const threeSecDist = document.getElementById('three-sec-distance');
        const userCar = document.getElementById('user-car');
        const brakeBtn = document.getElementById('brake-btn');
        const brakeFeedback = document.getElementById('brake-feedback');
        
        const safeDistanceTable = [ // D·ªØ li·ªáu t·ª´ B·∫£ng 11.1
            { maxSpeed: 60, distance: 35 },
            { maxSpeed: 80, distance: 55 },
            { maxSpeed: 100, distance: 70 },
            { maxSpeed: 120, distance: 100 }
        ];

        function getLegalDistance(speed) {
            for (const rule of safeDistanceTable) {
                if (speed <= rule.maxSpeed) return rule.distance;
            }
            return 100; // M·∫∑c ƒë·ªãnh cho t·ªëc ƒë·ªô > 100
        }

        function updateSimulation() {
            const speed_kmh = parseInt(speedSlider.value);
            speedValue.textContent = speed_kmh;
            
            // T√≠nh to√°n
            const speed_ms = speed_kmh / 3.6;
            const legal_dist_m = getLegalDistance(speed_kmh);
            const three_sec_dist_m = speed_ms * 3;
            
            // C·∫≠p nh·∫≠t th√¥ng tin
            legalDist.textContent = `${legal_dist_m} m`;
            threeSecDist.textContent = `${three_sec_dist_m.toFixed(0)} m`;
            
            // C·∫≠p nh·∫≠t v·ªã tr√≠ xe (gi·∫£ l·∫≠p)
            // Gi·∫£ s·ª≠ xe tr∆∞·ªõc ·ªü 70%, kho·∫£ng c√°ch 100m t∆∞∆°ng ·ª©ng v·ªõi 50% chi·ªÅu d√†i ƒë∆∞·ªùng
            const maxDistPercentage = 50; 
            const currentDistPercentage = Math.min((three_sec_dist_m / 100) * maxDistPercentage, maxDistPercentage);
            userCar.style.left = `${70 - currentDistPercentage}%`;
        }

        brakeBtn.addEventListener('click', () => {
            const speed_kmh = parseInt(speedSlider.value);
            const legal_dist_m = getLegalDistance(speed_kmh);
            
            const frontCarPos = parseFloat(document.getElementById('front-car').style.left);
            const userCarPos = parseFloat(userCar.style.left);
            // Quy ƒë·ªïi % sang m√©t (gi·∫£ l·∫≠p: 50% chi·ªÅu d√†i ƒë∆∞·ªùng = 100m)
            const current_dist_m = (frontCarPos - userCarPos) / 50 * 100;

            userCar.classList.remove('crashed'); // Reset animation
            void userCar.offsetWidth; // Trigger reflow

            if (current_dist_m >= legal_dist_m) {
                brakeFeedback.textContent = "An to√†n!";
                brakeFeedback.style.color = 'var(--correct-color)';
            } else {
                brakeFeedback.textContent = "Nguy hi·ªÉm! B·∫°n ƒë√£ kh√¥ng gi·ªØ kho·∫£ng c√°ch an to√†n.";
                brakeFeedback.style.color = 'var(--incorrect-color)';
                userCar.classList.add('crashed');
            }
        });

        speedSlider.addEventListener('input', updateSimulation);
        updateSimulation(); // Ch·∫°y l·∫ßn ƒë·∫ßu

        // --- PH·∫¶N II: BI·ªÇU ƒê·ªí ---
        const ctx = document.getElementById('traffic-chart').getContext('2d');
        const trafficChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['2016', '2017', '2018', '2019', '2020'],
                datasets: [
                    {
                        label: 'S·ªë v·ª• TNGT',
                        data: [21589, 20280, 18736, 17626, 14510],
                        backgroundColor: 'rgba(33, 150, 243, 0.7)', // M√†u xanh
                    },
                    {
                        label: 'S·ªë ng∆∞·ªùi ch·∫øt',
                        data: [8685, 8279, 8248, 7624, 6700],
                        backgroundColor: 'rgba(255, 193, 7, 0.7)', // M√†u v√†ng
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Th·ªëng k√™ TNGT ƒë∆∞·ªùng b·ªô Vi·ªát Nam (2016-2020)'
                    }
                }
            }
        });
        
        // --- PH·∫¶N IV: TR·∫ÆC NGHI·ªÜM ---
        document.querySelectorAll('#phan4 input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const name = this.name;
                const feedbackEl = document.getElementById('feedback-' + name);
                if (this.dataset.correct) {
                    feedbackEl.textContent = "Ch√≠nh x√°c!";
                    feedbackEl.className = 'feedback correct';
                } else {
                    feedbackEl.textContent = "Ch∆∞a ƒë√∫ng, h√£y suy nghƒ© l·∫°i.";
                    feedbackEl.className = 'feedback incorrect';
                }
            });
        });

        // --- FOOTER & BACK-TO-TOP ---
        const backToTopBtn = document.getElementById("back-to-top-btn");
        if(backToTopBtn){ window.onscroll = () => { backToTopBtn.style.display = (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) ? "block" : "none"; }; }
        const footer = document.querySelector('.site-footer');
        if (footer) footer.innerHTML = `<div class="container"><div class="footer-grid"><div><h4>Ngu·ªìn tham kh·∫£o</h4><ul><li>S√°ch gi√°o khoa KHTN 7 - B·ªô s√°ch K·∫øt n·ªëi tri th·ª©c.</li></ul></div><div><h4>V·ªÅ trang web</h4><ul><li><a href="/">V·ªÅ trang danh s√°ch h·ªçc li·ªáu</a></li></ul></div><div><h4>B·∫£n quy·ªÅn & Li√™n h·ªá</h4><p>&copy; <span id="copyright-year">${new Date().getFullYear()}</span>-nungvanhien</p><p>G√≥p √Ω: <a href="mailto:gopy@example.com">vanhien1199</a></p></div></div></div>`;
    });
    </script>
</body>
</html>